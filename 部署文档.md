# PetMaster 部署指南

## 方式一：使用 Docker Compose 部署（推荐）

### 1. 准备环境变量

创建 `.env` 文件：

```bash
DATABASE_USER=petmaster
DATABASE_PASSWORD=your_secure_password
DATABASE_NAME=pet_shop_db
SECRET_KEY=your-very-secret-key-change-this-in-production
```

### 2. 启动服务

```bash
# 构建并启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 重启服务
docker-compose restart
```

### 3. 初始化数据

```bash
# 进入应用容器
docker-compose exec app bash

# 运行初始化脚本
python init_data.py
```

访问：http://localhost:8000/api/v1/docs

---

## 方式二：在 1Panel 上部署

### 1. 安装 MySQL

在 1Panel 应用商店安装 MySQL 8.0

配置：
- 数据库名：pet_shop_db
- 用户名：petmaster
- 密码：设置强密码

### 2. 导入数据库

```bash
# 在 1Panel MySQL 容器中执行
mysql -u petmaster -p pet_shop_db < petmaster.sql
```

### 3. 创建 Python 应用

在 1Panel 中创建 Python 应用：

**应用配置**：
- 名称：PetMaster
- Python 版本：3.10+
- 启动命令：`uvicorn main:app --host 0.0.0.0 --port 8000`

**环境变量**：
```
DATABASE_HOST=mysql容器IP
DATABASE_PORT=3306
DATABASE_USER=petmaster
DATABASE_PASSWORD=你的密码
DATABASE_NAME=pet_shop_db
SECRET_KEY=生成的密钥
```

### 4. 安装依赖

```bash
pip install -r requirements.txt
```

### 5. 初始化数据

```bash
python init_data.py
```

---

## 方式三：直接部署到服务器

### 1. 安装依赖

```bash
# 安装 Python 3.10+
sudo apt install python3.10 python3.10-venv python3-pip

# 安装 MySQL
sudo apt install mysql-server

# 安装系统依赖
sudo apt install gcc default-libmysqlclient-dev pkg-config
```

### 2. 配置项目

```bash
# 克隆或上传项目
cd /var/www/petmaster

# 创建虚拟环境
python3 -m venv .venv
source .venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

### 3. 配置数据库

```bash
# 登录 MySQL
mysql -u root -p

# 创建数据库和用户
CREATE DATABASE pet_shop_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'petmaster'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON pet_shop_db.* TO 'petmaster'@'localhost';
FLUSH PRIVILEGES;

# 导入数据
mysql -u petmaster -p pet_shop_db < petmaster.sql
```

### 4. 配置环境变量

创建 `.env` 文件，配置数据库连接。

### 5. 使用 Supervisor 管理进程

创建 `/etc/supervisor/conf.d/petmaster.conf`：

```ini
[program:petmaster]
directory=/var/www/petmaster
command=/var/www/petmaster/.venv/bin/gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
autostart=true
autorestart=true
stderr_logfile=/var/log/petmaster/error.log
stdout_logfile=/var/log/petmaster/access.log
```

启动服务：

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start petmaster
```

### 6. 配置 Nginx 反向代理

创建 `/etc/nginx/sites-available/petmaster`：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /uploads {
        alias /var/www/petmaster/uploads;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/petmaster /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## 生产环境注意事项

### 1. 安全配置

- 修改默认密钥 `SECRET_KEY`
- 使用强密码
- 配置防火墙规则
- 启用 HTTPS（使用 Let's Encrypt）

### 2. 性能优化

- 使用 gunicorn 多进程部署
- 配置数据库连接池
- 启用 Redis 缓存（可选）
- 配置 CDN 加速静态资源

### 3. 监控和日志

- 配置日志收集（loguru）
- 使用 Prometheus + Grafana 监控
- 配置错误告警

### 4. 备份策略

- 定期备份数据库
- 备份上传文件
- 配置自动备份脚本

---

## 前端对接配置

### uni-app 配置

在 uni-app 项目中配置 API 地址：

```javascript
// utils/request.js
const BASE_URL = process.env.NODE_ENV === 'development' 
  ? 'http://localhost:8000/api/v1'
  : 'https://api.your-domain.com/api/v1';

export const request = (options) => {
  return uni.request({
    url: BASE_URL + options.url,
    method: options.method || 'GET',
    data: options.data || {},
    header: {
      'Authorization': 'Bearer ' + uni.getStorageSync('token'),
      ...options.header
    }
  });
};
```

### 登录示例

```javascript
// 登录
const login = async (username, password) => {
  const res = await request({
    url: '/auth/login',
    method: 'POST',
    data: { username, password }
  });
  
  if (res.data.access_token) {
    uni.setStorageSync('token', res.data.access_token);
  }
};
```

---

## 常见问题

### 1. 数据库连接失败

检查：
- 数据库是否启动
- 连接信息是否正确
- 防火墙是否开放端口

### 2. JWT 认证失败

检查：
- SECRET_KEY 是否配置
- Token 是否过期
- Header 格式是否正确

### 3. CORS 错误

在 `.env` 中配置允许的域名：

```
CORS_ORIGINS=["http://localhost:3000","https://your-domain.com"]
```

---

## 技术支持

如有问题，请查看日志文件或联系技术支持。
